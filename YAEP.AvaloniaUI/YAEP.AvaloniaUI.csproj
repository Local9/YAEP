<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net9.0</TargetFramework>
    <Version>1.0.19</Version>
    <AssemblyVersion>1.0.19.0</AssemblyVersion>
    <FileVersion>1.0.19.0</FileVersion>
    <AssemblyName>YAEP</AssemblyName>
    <Nullable>enable</Nullable>
    <ApplicationManifest>app.manifest</ApplicationManifest>
    <ApplicationIcon>Assets\yaep-icon.ico</ApplicationIcon>
    <AvaloniaUseCompiledBindingsByDefault>true</AvaloniaUseCompiledBindingsByDefault>
    <!-- Restrict to Windows runtimes only to reduce build size -->
    <RuntimeIdentifiers>win-x64</RuntimeIdentifiers>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|AnyCPU'">
    <DebugType>embedded</DebugType>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|AnyCPU'">
    <DebugType>embedded</DebugType>
  </PropertyGroup>

  <ItemGroup>
    <AvaloniaResource Include="Assets\**" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Avalonia" Version="11.3.10" />
    <PackageReference Include="Avalonia.Desktop" Version="11.3.10" />
    <PackageReference Include="Avalonia.Fonts.Inter" Version="11.3.10" />
    <PackageReference Include="Avalonia.Controls.DataGrid" Version="11.3.10" />
    <PackageReference Include="Avalonia.Controls.ColorPicker" Version="11.3.10" />
    <!--Condition below is needed to remove Avalonia.Diagnostics package from build output in Release configuration.-->
    <PackageReference Include="Avalonia.Diagnostics" Version="11.3.10">
      <IncludeAssets Condition="'$(Configuration)' != 'Debug'">None</IncludeAssets>
      <PrivateAssets Condition="'$(Configuration)' != 'Debug'">All</PrivateAssets>
    </PackageReference>
    <PackageReference Include="CommunityToolkit.Mvvm" Version="8.4.0" />
    <PackageReference Include="H.NotifyIcon" Version="2.4.1" />
    <PackageReference Include="Lucide.Avalonia" Version="0.1.54" />
    <PackageReference Include="Microsoft.Data.Sqlite" Version="10.0.1" />
    <PackageReference Include="Microsoft.Extensions.Hosting" Version="10.0.1" />
    <PackageReference Include="SukiUI" Version="6.0.3" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\YAEP.Interop\YAEP.Interop.csproj" />
  </ItemGroup>

  <ItemGroup>
    <AvaloniaResource Update="Assets\yaep-icon.ico">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </AvaloniaResource>
  </ItemGroup>

  <!-- Ensure app.manifest is copied to output -->
  <ItemGroup>
    <None Update="app.manifest">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <!-- Reorganize output: exe at root, all DLLs in bin subfolder -->
  <!-- Files are copied to reorganized location but original location is preserved for publish operations -->
  <Target Name="ReorganizeOutput" AfterTargets="Build">
    <PropertyGroup>
      <SourceDir>$(OutDir)</SourceDir>
      <TargetConfigDir>$([System.IO.Path]::Combine('$(MSBuildProjectDirectory)', 'bin', '$(Configuration)'))\</TargetConfigDir>
      <TargetBinDir>$([System.IO.Path]::Combine('$(MSBuildProjectDirectory)', 'bin', '$(Configuration)', 'bin'))\</TargetBinDir>
      <FinalExePath>$(TargetConfigDir)$(AssemblyName).exe</FinalExePath>
    </PropertyGroup>
    
    <!-- Create target directories -->
    <MakeDir Directories="$(TargetConfigDir)" />
    <MakeDir Directories="$(TargetBinDir)" />
    
    <!-- Collect files from source directory -->
    <ItemGroup>
      <ExeFile Include="$(SourceDir)$(AssemblyName).exe" />
      <MainDllFile Include="$(SourceDir)$(AssemblyName).dll" />
      <MainDllPdbFile Include="$(SourceDir)$(AssemblyName).pdb" />
      <MainDepsFile Include="$(SourceDir)$(AssemblyName).deps.json" />
      <MainRuntimeConfigFile Include="$(SourceDir)$(AssemblyName).runtimeconfig.json" />
      <ManifestFile Include="$(SourceDir)app.manifest" />
      <AllSourceFiles Include="$(SourceDir)**\*" />
      <NonExeFiles Include="@(AllSourceFiles)" Exclude="$(SourceDir)$(AssemblyName).exe;$(SourceDir)$(AssemblyName).dll;$(SourceDir)$(AssemblyName).pdb;$(SourceDir)$(AssemblyName).deps.json;$(SourceDir)$(AssemblyName).runtimeconfig.json;$(SourceDir)app.manifest" />
    </ItemGroup>
    
    <!-- Copy executable and main DLL files to config root (runtime needs main DLL in same dir as exe) -->
    <Copy SourceFiles="@(ExeFile)" DestinationFolder="$(TargetConfigDir)" SkipUnchangedFiles="true" Condition="'%(ExeFile.Identity)' != ''" />
    <Copy SourceFiles="@(MainDllFile)" DestinationFolder="$(TargetConfigDir)" SkipUnchangedFiles="true" Condition="'%(MainDllFile.Identity)' != ''" />
    <Copy SourceFiles="@(MainDepsFile)" DestinationFolder="$(TargetConfigDir)" SkipUnchangedFiles="true" Condition="'%(MainDepsFile.Identity)' != ''" />
    <Copy SourceFiles="@(MainRuntimeConfigFile)" DestinationFolder="$(TargetConfigDir)" SkipUnchangedFiles="true" Condition="'%(MainRuntimeConfigFile.Identity)' != ''" />
    <Copy SourceFiles="@(ManifestFile)" DestinationFolder="$(TargetConfigDir)" SkipUnchangedFiles="true" Condition="'%(ManifestFile.Identity)' != ''" />
    
    <!-- Keep a copy at the old location for IDE debugging -->
    <Copy SourceFiles="@(ExeFile)" DestinationFolder="$(SourceDir)" SkipUnchangedFiles="true" Condition="'%(ExeFile.Identity)' != '' and '$(Configuration)' == 'Debug'" />
    <Copy SourceFiles="@(MainDllFile)" DestinationFolder="$(SourceDir)" SkipUnchangedFiles="true" Condition="'%(MainDllFile.Identity)' != '' and '$(Configuration)' == 'Debug'" />
    
    <!-- Copy all other files (dependencies, runtimes, etc.) to bin subfolder, preserving relative directory structure -->
    <!-- RecursiveDir will contain the path relative to SourceDir (e.g., "runtimes\win-x64\native\") -->
    <Copy SourceFiles="@(NonExeFiles)" DestinationFiles="@(NonExeFiles->'$(TargetBinDir)%(RecursiveDir)%(Filename)%(Extension)')" SkipUnchangedFiles="true" />
    
    <!-- Don't delete source directory to avoid interfering with publish operations -->
    <!-- Files remain in both locations: original (for publish) and reorganized (for local use) -->
  </Target>

  <!-- Reorganize publish output: exe at root, all DLLs in bin subfolder -->
  <!-- This ensures the published output matches the local Release folder structure -->
  <Target Name="ReorganizePublishOutput" AfterTargets="Publish" Condition="'$(PublishDir)' != ''">
    <PropertyGroup>
      <PublishSourceDir Condition="!HasTrailingSlash('$(PublishDir)')">$(PublishDir)\</PublishSourceDir>
      <PublishSourceDir Condition="HasTrailingSlash('$(PublishDir)')">$(PublishDir)</PublishSourceDir>
      <PublishTargetBinDir>$([System.IO.Path]::Combine('$(PublishDir)', 'bin'))\</PublishTargetBinDir>
    </PropertyGroup>
    
    <!-- Create bin subfolder -->
    <MakeDir Directories="$(PublishTargetBinDir)" />
    
    <!-- Collect all files recursively from publish directory -->
    <ItemGroup>
      <PublishAllFiles Include="$(PublishSourceDir)**\*" />
      <!-- Files to keep at root: exe, main dll, deps.json, runtimeconfig.json, manifest -->
      <PublishKeepAtRoot Include="$(PublishSourceDir)$(AssemblyName).exe;$(PublishSourceDir)$(AssemblyName).dll;$(PublishSourceDir)$(AssemblyName).deps.json;$(PublishSourceDir)$(AssemblyName).runtimeconfig.json;$(PublishSourceDir)app.manifest" />
      <!-- All other files go to bin subfolder -->
      <PublishFilesToMove Include="@(PublishAllFiles)" Exclude="@(PublishKeepAtRoot)" />
    </ItemGroup>
    
    <!-- Calculate relative paths and move files to bin, preserving directory structure -->
    <!-- For files at root level, RecursiveDir will be empty -->
    <!-- For files in subdirectories, RecursiveDir will contain the subdirectory path -->
    <Copy SourceFiles="@(PublishFilesToMove)" DestinationFiles="@(PublishFilesToMove->'$(PublishTargetBinDir)%(RecursiveDir)%(Filename)%(Extension)')" SkipUnchangedFiles="true" Condition="'@(PublishFilesToMove)' != ''" />
    <Delete Files="@(PublishFilesToMove)" Condition="'@(PublishFilesToMove)' != ''" />
    
    <!-- Remove empty runtimes directory from publish root after files are moved to bin -->
    <PropertyGroup>
      <RuntimesDir>$([System.IO.Path]::Combine('$(PublishSourceDir)', 'runtimes'))</RuntimesDir>
    </PropertyGroup>
    <RemoveDir Directories="$(RuntimesDir)" Condition="Exists('$(RuntimesDir)')" ContinueOnError="true" />
  </Target>
  
</Project>
